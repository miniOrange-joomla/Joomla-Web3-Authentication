import {WalletConnectModalSign as e} from "../walletconnect/dist/cdn/bundle.js";

let web3Modal = new e({projectId: "8cbc51134cb272bb74d29cd8132a85d4"});
jQuery(document).ready(function($){
    var root_url = document.getElementById('mo_root_url').value;
    ajaxurl = root_url+'ajax.php';
});

async function onConnect() {
    return new Promise(async (e, n) => {
        let t = null;
        try {
            connectButton.disabled = !0, t = await web3Modal.connect({
                requiredNamespaces: {
                    eip155: {
                        methods: ["eth_signTransaction", "personal_sign"],
                        chains: ["eip155:1"],
                        events: ["chainChanged", "accountsChanged"]
                    }
                }
            })
        } catch (a) {
            n(a)
        } finally {
            connectButton.disabled = !1, e(t)
        }
    })
}

async function signMessage(e, n) {
    let mo_nonce = document.getElementById('mo_points').value;

    return new Promise((t, a) => {
        try {
            jQuery.post(ajaxurl, {
                action: "type_of_request",
                request: "login",
                address: n,
                mo_web3_verify_nonce: mo_nonce
            }, function (a) {
                if ("Error" !== a.substring(0, 5)) {
                    let c = web3Modal.request({
                        topic: e.topic,
                        chainId: "eip155:1",
                        request: {method: "personal_sign", params: [a, n,]}
                    });
                    t(c)
                }
            })
        } catch (c) {
            a(c)
        }
    })
}

function handleAuthenticate(e, n, isTesting) {
    let mo_nonce = document.getElementById('mo_points').value;
    var t = {action: "type_of_request", address: e, request: "auth", signature: n, mo_web3_verify_nonce: mo_nonce};
    jQuery.post(ajaxurl, t, function (n) {
        n = JSON.parse(n);
        if (n.isSignatureVerified) {
            if (isTesting) {
                openModal(e);
            }
            else {
                let t = e;
                is_testing_wallet_address && (t = is_testing_wallet_address);
                post_to_url("", {address: e, nonce: n.nonce}, "post", "mo_web3_hiddenform_nonce")
            }
        }
    })
}

async function moweb3WalletConnect() {

    var currentURL = window.location.href;
    var urlToCompare = 'administrator';

    jQuery("#multipleCryptowalletModal").modal("hide");
    let e = await onConnect(), n = e.namespaces.eip155.accounts[0].split(":")[2], t = await signMessage(e, n);

    if (currentURL.includes(urlToCompare)) {
        try {

            let isTesting = 1;
            handleAuthenticate(n, t, isTesting)
        } catch (a) {
        }
    } else {
        try {
            let isTesting = 0;
            handleAuthenticate(n, t, isTesting)
        } catch (a) {
        }
    }
}
let connectButton = document.getElementById("moweb3WalletConnect");
connectButton.addEventListener("click", moweb3WalletConnect);
